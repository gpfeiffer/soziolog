<% content_for :side do %>
<h3>Reports</h3>
<ul>
<% @transactions_by_year.keys.sort.reverse.each do |key| %>
<li>
<%= link_to_unless_current key, labels_path(:year => key) %>
</li>
<% end %>
</ul>
<% end %>

<h1>Report <%= @year %></h1>

<h3>Current Account</h3>

<p>
<b>Opening Balance:</b> 
<% opening = @transactions.first.balance.previous.balance %>
<%= money opening %>
</p>

<p>
<b>Closing Balance:</b> 
<% closing = @transactions.last.balance.balance %>
<%= money closing %>
</p>
<p>

<p>
<b>Movement:</b> 
<% movement = closing - opening %>
<%= money movement %>
</p>

<% transactions_by_sign = @transactions.group_by(&:sign) %>
<% "+-".chars.each do |sign| %>
  <% transactions = transactions_by_sign[sign] %>
  <h2><%= sign %></h2>
  <table>
  <% transactions.map(&:labels).sum.group_by(&:category).each do |cat, labels| %>
  <tr><th><%= cat %>:</th><td align="right"><%= money labels.map(&:amount).sum %></td></tr>
  <% end %>
  <tr><th>Sum:</th><td align="right"><%= money transactions.map(&:amount).sum %></td></tr>
  </table>
<% end %>

<p>
<b>Total:</b> 
<% total = @transactions.map(&:amount).sum %>
<%= money total %>
</p>

<p>
<b>Error:</b> 
<%= money movement - total %>
</p>


